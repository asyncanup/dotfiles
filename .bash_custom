# ---- typically bashrc stuff ----

# enable programmable completion features (you don't need to enable
# this, if it's already enabled in /etc/bash.bashrc and /etc/profile
# sources /etc/bash.bashrc).
if ! shopt -oq posix; then
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi

[ -f ~/.fzf.bash ] && source ~/.fzf.bash

[ -f ~/.z.bash ] && source ~/.z.bash

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

# powerline shell
function _update_ps1() {
  PS1=$(powerline-shell $?)
}

if [[ $TERM != linux && ! $PROMPT_COMMAND =~ _update_ps1 ]]; then
  PROMPT_COMMAND="_update_ps1; $PROMPT_COMMAND"
fi

# pyenv
export PYENV_VIRTUALENV_DISABLE_PROMPT=1
export PATH="~/.pyenv/bin:$PATH"
command -v pyenv &> /dev/null && eval "$(pyenv init -)"
command -v pyenv &> /dev/null && eval "$(pyenv virtualenv-init -)"

# go
export GOROOT=/usr/local/go
export GOPATH=$HOME/src
export PATH=$PATH:$GOPATH/bin:$GOROOT/bin

# ---- save history across terminals ----
HISTCONTROL=ignoredups:erasedups
shopt -s histappend
PROMPT_COMMAND="${PROMPT_COMMAND:+$PROMPT_COMMAND$'\n'}history -a; history -c; history -r"

export PATH="$PATH:~/bin:~/.local/bin:~/bin/node_modules/.bin"

# ---- comment this when you want pyenv to control python ----
#export PATH="/usr/bin:/usr/local/bin:$PATH"

# ---- colors ----
BLACK='\033[0;30m'
DARKGRAY='\033[1;30m'
RED='\033[0;31m'
LIGHTRED='\033[1;31m'
GREEN='\033[0;32m'
LIGHTGREEN='\033[1;32m'
ORANGE='\033[0;33m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
LIGHTBLUE='\033[1;34m'
PURPLE='\033[0;35m'
LIGHTPURPLE='\033[1;35m'
CYAN='\033[0;36m'
LIGHTCYAN='\033[1;36m'
LIGHTGRAY='\033[0;37m'
WHITE='\033[1;37m'
RESET='\033[0m'

# ---- git shortcuts ----
is_in_git_repo() {
  git rev-parse HEAD > /dev/null 2>&1
}

function glog() {
  is_in_git_repo || return
  git log --graph --color=always --format="%C(auto)%h%d %s %C(black)%C(bold)%cr" $1 | \
   fzf --height 75% --ansi --no-sort --reverse --tiebreak=index --preview \
   'f() { set -- $(echo -- "$@" | grep -o "[a-f0-9]\{7\}"); [ $# -eq 0 ] || git show --color=always $1 ; }; f {}' \
   --bind "alt-j:preview-down,alt-k:preview-up,alt-d:preview-page-down,alt-u:preview-page-up,ctrl-m:execute:
      (grep -o '[a-f0-9]\{7\}' | head -1 |
      xargs -I % sh -c 'git show --color=always % | less -R') << 'FZF-EOF'
      {}
FZF-EOF" --preview-window=right:60%
}

git-files() {
  is_in_git_repo || return
  git -c color.status=always status --short |
  fzf --height 90% -m --ansi --nth 2..,.. \
    --preview '(git diff --color=always -- {-1} | sed 1,4d; bat --color always {-1})' \
    --bind "alt-j:preview-down,alt-k:preview-up,alt-d:preview-page-down,alt-u:preview-page-up" \
    --preview-window=right:70% |
  cut -c4- | sed 's/.* -> //'
}

git-branches() {
  is_in_git_repo || return
  git branch -a --color=always | grep -v '/HEAD\s' | sort |
  fzf --height 50% --ansi --multi --tac \
    --preview 'git log --oneline --graph --date=short --color=always --pretty="format:%C(auto)%cd %h%d %s" $(sed s/^..// <<< {} | cut -d" " -f1) | head -'$LINES \
    --bind "alt-j:preview-down,alt-k:preview-up,alt-d:preview-page-down,alt-u:preview-page-up" \
    --preview-window=right:70% |
  sed 's/^..//' | cut -d' ' -f1 |
  sed 's#^remotes/##'
}

git-tags() {
  is_in_git_repo || return
  git tag --sort -version:refname |
  fzf --height 50% --multi \
    --preview 'git show --color=always {} | head -'$LINES \
    --bind "alt-j:preview-down,alt-k:preview-up,alt-d:preview-page-down,alt-u:preview-page-up" \
    --preview-window=right:70%
}

git-commit-hashes() {
  is_in_git_repo || return
  git log --date=short --format="%C(green)%C(bold)%cd %C(auto)%h%d %s (%an)" --graph --color=always |
  fzf --height 50% --ansi --no-sort --reverse --multi \
    --preview 'grep -o "[a-f0-9]\{7,\}" <<< {} | xargs git show --color=always | head -'$LINES \
    --bind "alt-j:preview-down,alt-k:preview-up,alt-d:preview-page-down,alt-u:preview-page-up" \
    --preview-window=right:40% |
  grep -o "[a-f0-9]\{7,\}"
}

git-remotes() {
  is_in_git_repo || return
  git remote -v | awk '{print $1 "\t" $2}' | uniq |
  fzf --height 50% --tac \
    --preview 'git log --oneline --graph --date=short --pretty="format:%C(auto)%cd %h%d %s" {1} | head -200' \
    --bind "alt-j:preview-down,alt-k:preview-up,alt-d:preview-page-down,alt-u:preview-page-up" \
    --preview-window=right:70% |
  cut -d$'\t' -f1
}

alias gcd='cd $(git rev-parse --show-toplevel)'
function gcf() {
  files="$(git-files)"
  if [[ $files != '' ]]; then
    git add $files
    git commit --verbose
  fi
}
gdbr() {
  git diff $(git merge-base $1 HEAD)..HEAD
}
alias gdm='git diff $(git merge-base master HEAD)..HEAD'
alias gcof='git checkout $(git branch | fzf)'
alias gaf='git add $(git-files)'
function gg() {
  echo
  git status -s
  if [[ $? != 0 ]]; then
    return 1
  fi
  echo
  printf "${BLUE}a) add, (d) diff, (c) commit, (l) log, (r) reset${RESET}: "
  read -s -n1 key
  echo
  case $key in
    $'\e'|q)    return 0 ;;
    a)          gcf ;;
    d)          gd ;;
    c)          gc ;;
    l)          glog ;;
    r)          gr ;;
    *)          ;;
  esac
  gg
}

alias g='git'
complete -F _complete_alias g

alias gs='g s'
alias gcl='g cl'
alias gd='g d'
alias gdc='g dc'
alias gdi='g di'
alias gsh='g sh'
alias gco='g co'
alias gcob='g cob'
alias ga='g a'
alias gap='g ap'
alias gst='g st'
alias gstl='g stl'
alias gstp='g stp'
alias gsts='g sts'
alias gstc='g stc'
alias gc='g c'
alias gcm='g cm'
alias gcam='g cam'
alias gcc='g cc'
alias gca='g ca'
alias gb='g b'
alias gbd='g bd'
alias gbD='g bD'
alias gl='g l'
alias gr='g r'
alias grs='g rs'
alias grh='g rh'
alias grsh='g rsh'
alias grhh='g rhh'
alias grp='g rp'
alias grev='g rev'
alias gcat='g cat'
alias gpl='g pl'
alias gpom='g pom'
alias gtype='g type'
alias gm='g m'
alias gmf='g mf'
alias grb='g rb'
alias grbm='g rbm'
alias grba='g rba'

bind '"\er": redraw-current-line'
bind '"\C-g\C-f": "$(git-files)\e\C-e\er"'
bind '"\C-g\C-b": "$(git-branches)\e\C-e\er"'
bind '"\C-g\C-t": "$(git-tags)\e\C-e\er"'
bind '"\C-g\C-h": "$(git-commit-hashes)\e\C-e\er"'
bind '"\C-g\C-r": "$(git-remotes)\e\C-e\er"'

# ---- other aliases ----
export EDITOR="nvim"
export VISUAL="nvim"
export PAGER="bat --paging always"
export MANPAGER=most

shopt -s nocaseglob

alias less='less -K'
alias rmf='rm -rf'
alias cl='clear'

alias b='bazel'
complete -F _complete_alias b
alias bb='bazel build'
alias bbv='bazel build --verbose_failures --sandbox_debug'
alias br='bazel run'
alias brv='bazel run'
alias bq='bazel query'
alias bc='bazel clean'
alias bce='bazel clean --expunge'
alias bqb='bazel query --output=build'
alias bqr='bazel query --output=run'

alias sbr='. ~/.bashrc'
alias sbc='. ~/.bash_custom'
alias sbcl='. ~/.bash_custom.local'
alias seb='nvim ~/.bashrc && . ~/.bashrc'
alias sebc='nvim ~/.bash_custom && . ~/.bash_custom'

alias c='xclip -selection clipboard'
alias v='xclip -selection cliboard -o'

alias apt='sudo apt-get install'
alias aptremove='sudo apt-get remove'
alias aptupdate='sudo apt-get update'

alias ..='cd ..'

# FZF fuzzy finder settings
export FZF_DEFAULT_COMMAND='rg --hidden'
export FZF_DEFAULT_OPTS='--no-info --height 50% --reverse'
export FZF_CTRL_T_COMMAND='rg --hidden --files'
export FZF_CTRL_T_OPTS='--preview "bat --style=numbers --color=always {}" --bind "alt-j:preview-down,alt-k:preview-up,alt-d:preview-page-down,alt-u:preview-page-up"'
complete -F _fzf_dir_completion -o default -o bashdefault tree

alias d='docker'
alias db='docker build .'
alias dps='docker ps'
alias di='docker images'
complete -F _complete_alias d

alias e='nvim'
complete -F _complete_alias e

alias psa='ps -a | grep'
alias kk='kill -9'
alias jl='jobs -l'
alias killjobs="kill -9 $(jobs -p)"
alias k='kill'
complete -F _complete_alias k

# todo tools
alias t='echo "$(date +%H:%M)" >> ~/.todo'
alias t-newday="echo $'\n'$(date +%Y-%m-%d)$'\n' >> ~/.todo"
alias t-edit='nvim ~/.todo'
alias t-entry='echo >> ~/.todo'
alias t-tail='tail ~/.todo'
alias tt='t-tail'
alias t-amend='LAST_TIME=$(tail -1 ~/.todo | sed -n '\''s/^\([0-9]*:[0-9]*\) .*/\1/p'\'') && [[ ! -z "$LAST_TIME" ]] && tmpfile=$(mktemp) && head -n -1 ~/.todo > $tmpfile && cat $tmpfile > ~/.todo && rm $tmpfile && echo "$LAST_TIME" >> ~/.todo'

# nnn file manager
n ()
{
    # Block nesting of nnn in subshells
    if [ "${NNNLVL:-0}" -ge 1 ]; then
        echo "nnn is already running"
        return
    fi
    NNN_TMPFILE="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.lastd"
    # Unmask ^Q (, ^V etc.) (if required, see `stty -a`) to Quit nnn
    # stty start undef
    # stty stop undef
    # stty lwrap undef
    # stty lnext undef
    nnn -c "$@"
    if [ -f "$NNN_TMPFILE" ]; then
            . "$NNN_TMPFILE"
            rm -f "$NNN_TMPFILE" > /dev/null
    fi
}
export NNN_PLUG='x:_chmod +x $nnn;g:_git status;o:fzopen;t:_tree $nnn;c:_/home/abishnoi/bin/copyfilepath $nnn'
export NNN_CONTEXT_COLORS='4123'
export NNN_TRASH=1

alias nb='npm run build'
alias ns='npm start'
alias nr='npm run'

alias pv='python --version'
alias nv='node -v'

# asciinema shell recordings
alias rec='asciinema rec -i 1 .shell-recordings/`date +%Y-%m-%d`.cast'
alias recplay='asciinema play -i 0.1'

# yadm dotfiles manager
yadm-git-files() {
  yadm -c color.status=always status --short |
  fzf --height 90% -m --ansi --nth 2..,.. \
    --preview '(yadm diff --color=always -- {-1} | sed 1,4d; bat --color always {-1})' \
    --bind "alt-j:preview-down,alt-k:preview-up,alt-d:preview-page-down,alt-u:preview-page-up" \
    --preview-window=right:70% |
  cut -c4- | sed 's/.* -> //'
}
alias ycf='yadm add $(yadm-git-files); yadm commit --verbose'

alias ya='yadm add'
alias yd='yadm diff'
alias yl='yadm list'
alias yc='yadm commit --verbose'
alias yca='yadm commit -a --verbose'
alias ys='yadm status'
alias yp='yadm push'

# searching and opening web links
function s() {
  lynx https://duckduckgo.com/?q="$*"
}
function g() {
  lynx https://google.com/?q="$*"
}
alias l="lynx"

# lynx config location
export LYNX_CFG=~/.config/lynx/lynx.cfg
export LYNX_LSS=~/.config/lynx/lynx.lss

# replacing rm with trash-cli
alias trash='~/.pyenv/versions/3.7.0/bin/trash-put'
alias rm='\rm'

# select directors with fzf
list-dirs() {
  fd ${1:-.} -t d |
  fzf --height 50% --multi --ansi
}
bind '"\C-f\C-d": "$(list-dirs)\e\C-e\er"'

# fd shortcuts
alias fdh='fd --hidden'
alias fdi='fd --no-ignore'
alias fdih='fd --hidden --no-ignore'

alias diff='git diff --no-index'

# ---- load local customization file ----
[ -s "$HOME/.bash_custom.local" ] && \. "$HOME/.bash_custom.local"

# ---- end ----

